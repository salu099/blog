<!DOCTYPE html>


<html lang="zh-tw">
<meta content="c#, google photos api, httpwebrequest, mvc, oauth2" name="keywords">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    
  
  <meta name="description" content="傻露一直是picasa的使用者，但google提供的picasa api無法取得完整的google photos資料，在今年5月看到google釋出photos api的消息，就來花點時間嘗試看看如何來取得自己帳戶內的照片資料。">
  
  
  <meta name="generator" content="Hugo 0.24.1" />

  <title>使用c#連接google photos api實作 &middot; 小卷的胡言亂語</title>

  
  <meta property="og:language" content="zh-TW"/>
  <meta property="og:site_name" content="使用c#連接google photos api實作"/>  
  <meta property="og:title" content="使用c#連接google photos api實作" />
  <meta property="og:description" content="傻露一直是picasa的使用者，但google提供的picasa api無法取得完整的google photos資料，在今年5月看到google釋出photos api的消息，就來花點時間嘗試看看如何來取得自己帳戶內的照片資料。" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://salu099.github.io/blog/2018/06/csharp-google-photos-api/" />
  
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://salu099.github.io/blog/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://salu099.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://salu099.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  

<link rel="shortcut icon" href="https://salu099.github.io/blog/img/favicon_5.ico" type="image/x-icon" />
<link rel="bookmark" href="https://salu099.github.io/blog/img/favicon_5.ico"/>


  
  

    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>    
  <link rel="stylesheet" href="https://salu099.github.io/blog/css/menutree/menutree.css" />
  
    
  <script>
  <!--2017/7 add 'go to top' in header.html start-->
  <!--ref: https:
	window.onscroll = function() {scrollFunction()};

	function scrollFunction() {
		if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
			document.getElementById("myToTopBtn").style.display = "block";
		} else {
			document.getElementById("myToTopBtn").style.display = "none";
		}
	}

	
	function topFunction() {
		document.body.scrollTop = 0;
		document.documentElement.scrollTop = 0;
	}	
	<!--2017/7 add 'go to top' in header.html end-->
	<!--2017/7 add site visitor counter start: change to use histats-->
	
	<!-- $(document).ready(function(){ -->
		<!-- $('a').click(function() { -->
			<!-- if ($(this).hasClass('sociallink')) {}else{ -->
				<!-- $.get("https://script.google.com/macros/s/AKfycbyxudu5idxrDOAUO7QNuEmSq0jljc-5BqjN56h85zlx3Nv9X48/exec", -->
					<!-- function (data) {return false;} -->
				<!-- ); -->
			<!-- } -->
		<!-- }); -->
    <!-- }); -->
	
	
	
	<!-- $.get("https://script.google.com/macros/s/AKfycbxl_kU3_ClDtWRlT22AP3y4hdTxsS7GWxSLuv6gmXuk3sn6p2M/exec", -->
		<!-- function (data) {        			 -->
			<!-- $("#visitornum").html(data); -->
		<!-- } -->
	<!-- ); -->
	<!--2017/7 add site visitor counter end: change to use histats-->
	
	<!--2017/9 add disqus controler button s-->
	<!--https:
	$(document).ready(function() {	
    $('.show-comments').on('click', function(){
          var disqus_shortname = 'salu099'; 

          
          $.ajax({
                  type: "GET",
                  url: "https://" + disqus_shortname + ".disqus.com/embed.js",
                  dataType: "script",
                  cache: true
          });
          
          $(this).fadeOut();
		});		
	});			
	<!--2017/9 add disqus controler button e-->
	
  </script>
  
  <style tyle="text/css">
  @import url(//fonts.googleapis.com/earlyaccess/notosanstc.css);
  .content{font-family: 'Noto Sans TC', sans-serif;}
  </style>
  
  
</head>


<body>

<button onclick="topFunction()" id="myToTopBtn" title="Go to top">TOP</button>


<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>

<div id="menu">

  
    
  
  <div class="avatarcontainer">  
	<div class="divavatar">
		<img src="https://salu099.github.io/blog/img/headimg.png" alt="salu099" style="width:90px;height:90px;" class="avatar">
	</div>  
	<a class="pure-menu-heading brand" href="https://salu099.github.io/blog/">旗津烤小卷/傻露</a>  
	<span>(salu099)</span>
  </div>
    


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">		
          <a class="pure-menu-link" href="https://salu099.github.io/blog/"><i class='fa fa-home fa-fw'></i>首頁</a>
      
        </li>
      
      
        <li class="pure-menu-item">		
          <a class="pure-menu-link" href="https://salu099.github.io/blog/post/"><i class='fa fa-archive fa-fw'></i>文章列表</a>
      
        </li>
      
      
        <li class="pure-menu-item">		
          <a class="pure-menu-link" href="https://salu099.github.io/blog/tags/"><i class='fa fa-tags fa-fw'></i>文章標籤</a>
      
        </li>
      
    </ul>
  </div>
  
  

 
<ul id="tree1">
	<li ><a href="#" style="margin-left:-8px">文章分類</a>
		<ul> 
		
			<li>台灣
				<ul>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E6%92%AE%E3%82%8B"><i class='fa fa-angle-right'></i>撮る</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E9%A3%9F%E3%81%B9%E3%82%8B"><i class='fa fa-angle-right'></i>食べる</a><span>(0)</span>
						</li>
					
				</ul>
			</li>
		
			<li>國外
				<ul>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E6%97%A5%E6%97%85%E7%AD%86%E8%A8%98"><i class='fa fa-angle-right'></i>日旅筆記</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E6%AD%90%E6%97%85%E7%AD%86%E8%A8%98"><i class='fa fa-angle-right'></i>歐旅筆記</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2018%E5%8C%97%E4%B9%9D%E5%B7%9E%E9%97%9C%E8%A5%BF"><i class='fa fa-angle-right'></i>2018北九州關西</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2017%E5%90%8D%E5%8F%A4%E5%B1%8B%E4%BA%AC%E9%83%BD"><i class='fa fa-angle-right'></i>2017名古屋京都</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2017%E6%B2%96%E7%B9%A9"><i class='fa fa-angle-right'></i>2017沖繩</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2016%E4%BA%AC%E9%83%BD"><i class='fa fa-angle-right'></i>2016京都</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2016%E9%AB%98%E6%9D%BE%E7%A5%9E%E6%88%B6"><i class='fa fa-angle-right'></i>2016高松神戶</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2015%E5%BE%B7%E5%9C%8B%E5%A5%A7%E5%9C%B0%E5%88%A9"><i class='fa fa-angle-right'></i>2015德國奧地利</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2014%E6%9D%B1%E4%BA%AC"><i class='fa fa-angle-right'></i>2014東京</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2013%E4%B9%9D%E5%B7%9E"><i class='fa fa-angle-right'></i>2013九州</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2013%E4%BA%AC%E9%98%AA%E7%A5%9E%E5%A5%88"><i class='fa fa-angle-right'></i>2013京阪神奈</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2012%E4%BA%AC%E9%98%AA"><i class='fa fa-angle-right'></i>2012京阪</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2011%E5%8C%97%E6%B5%B7%E9%81%93"><i class='fa fa-angle-right'></i>2011北海道</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/2007%E4%BA%AC%E9%98%AA"><i class='fa fa-angle-right'></i>2007京阪</a><span>(0)</span>
						</li>
					
				</ul>
			</li>
			
			<li>隨手記
				<ul>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E5%BF%83%E6%83%85%E9%9B%9C%E8%A8%98"><i class='fa fa-angle-right'></i>心情雜記</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E5%BB%9A%E5%A8%98%E7%AD%86%E8%A8%98"><i class='fa fa-angle-right'></i>廚娘筆記</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E7%A8%8B%E5%BC%8F%E7%AD%86%E8%A8%98"><i class='fa fa-angle-right'></i>程式筆記</a><span>(0)</span>
						</li>
													
						
						<li trclass="trhyzone">
						
						<a href="https://salu099.github.io/blog/topics/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%BB%BA%E7%BD%AE"><i class='fa fa-angle-right'></i>部落格建置</a><span>(0)</span>
						</li>
					
				</ul>
			</li>			
			
			
		</ul>
	</li>                
</ul>

<div id="existtopiczone" style="display:none">
	
		
            <li trclass="trhyzone">
                
                <a href="https://salu099.github.io/blog/topics/2013%E4%BA%AC%E9%98%AA%E7%A5%9E%E5%A5%88">
                    2013京阪神奈
                </a>
                <span >(22)</span>
            </li>
        
            <li trclass="trhyzone">
                
                <a href="https://salu099.github.io/blog/topics/2016%E4%BA%AC%E9%83%BD">
                    2016京都
                </a>
                <span >(9)</span>
            </li>
        
            <li trclass="trhyzone">
                
                <a href="https://salu099.github.io/blog/topics/%E6%92%AE%E3%82%8B">
                    撮る
                </a>
                <span >(51)</span>
            </li>
        
            <li trclass="trhyzone">
                
                <a href="https://salu099.github.io/blog/topics/%E7%A8%8B%E5%BC%8F%E7%AD%86%E8%A8%98">
                    程式筆記
                </a>
                <span >(4)</span>
            </li>
        
            <li trclass="trhyzone">
                
                <a href="https://salu099.github.io/blog/topics/%E9%83%A8%E8%90%BD%E6%A0%BC%E5%BB%BA%E7%BD%AE">
                    部落格建置
                </a>
                <span >(2)</span>
            </li>
        
            <li trclass="trhyzone">
                
                <a href="https://salu099.github.io/blog/topics/%E9%A3%9F%E3%81%B9%E3%82%8B">
                    食べる
                </a>
                <span >(22)</span>
            </li>
        
	
</div>



  <script>
   
	$.fn.extend({
    treed: function (o) {
      
      

      var openedClass = 'fa fa-folder-open icon-lg';
      var closedClass = 'fa fa-folder icon-lg';
      
      if (typeof o != 'undefined'){
        if (typeof o.openedClass != 'undefined'){
        openedClass = o.openedClass;
        }
        if (typeof o.closedClass != 'undefined'){
        closedClass = o.closedClass;
        }
      };
      
        
        var tree = $(this);
        tree.addClass("tree");
        tree.find('li').has("ul").each(function () {
            var branch = $(this); 
            branch.prepend("<i class='indicator glyphicon " + closedClass + "'></i>");
            branch.addClass('branch');
            branch.on('click', function (e) {
                if (this == e.target) {
                    var icon = $(this).children('i:first');
                    icon.toggleClass(openedClass + " " + closedClass);
                    $(this).children().children().toggle();
                }
            })
            branch.children().children().toggle();
        });
        
      tree.find('.branch .indicator').each(function(){
        $(this).on('click', function () {
            $(this).closest('li').click();
        });
      });
        
        tree.find('.branch>a').each(function () {
            $(this).on('click', function (e) {
                $(this).closest('li').click();
                e.preventDefault();
            });
        });
        
        tree.find('.branch>button').each(function () {
            $(this).on('click', function (e) {
                $(this).closest('li').click();
                e.preventDefault();
            });
        });
    }
});


$('#tree1').treed();
 

 






a_group = $('#tree1 li[trclass="trhyzone"]').each(function(){      
    var resultvl = comparison($(this).find('a').text().trim());    
    if(resultvl === ''){
		$(this).children('a').removeAttr('href');	
    }else{      
		$(this).find('span').text(resultvl);    
		$(this).children('a').hover(function() {	
			$(this).addClass("topichyperlink");
		}, function() {
			$(this).removeClass("topichyperlink");
		});
    }
});

 
function comparison(fdname){
	var result = '';
	$('#existtopiczone li[trclass="trhyzone"]').each(function(){         
      if(fdname === $(this).find('a').text().trim()){      	
      	result= $(this).find('span').text().trim();	
      }      
    });
    return result;
}
 

  </script>
  
  
<div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

      

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
	
	
	
	
    <li class="pure-menu-item">
      <a class="pure-menu-link sociallink" href="https://salu099.github.io/mygallery/about.html" target="_blank"><i class="fa fa-address-book-o fa-fw"></i>關於我</a>
    </li>
    
	
	
    <li class="pure-menu-item">
      <a class="pure-menu-link sociallink" href="https://salu099.github.io/mygallery/index.html" target="_blank"><i class="fa fa-picture-o fa-fw"></i>網路相簿</a>
    </li>
    	
	
	
    
      
    
    

	
    
      
    
    
	
	
	<li class="pure-menu-item">
		<a class = "pure-menu-link sociallink" href="https://travel98.com/member/90800/article" target="_blank"><i class="fa fa-plane fa-fw" data-fa-transform="rotate-90"></i>Travel98</a>
	</li>
	
	
	
    <li class="pure-menu-item">
	
      
	  <a class="pure-menu-link sociallink" href="https://github.com/salu099" target="_blank"><i class="fa fa-github fa-fw"></i>GitHub</a>
	  
    </li>
    	
	
	
	
	
	    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>

  
  <div>
    
  </div>
  <div class="small-print">
    
	<a rel="license" href="http://creativecommons.org/licenses/by-nd/4.0/"><img alt="創用 CC 授權條款" style="border-width:0" src="https://i.creativecommons.org/l/by-nd/4.0/80x15.png" /></a><br />本著作係採用<a rel="license" href="http://creativecommons.org/licenses/by-nd/4.0/">創用 CC 姓名標示-禁止改作 4.0 國際 授權條款</a>授權.
  </div>
  
  
  <div class="small-print">
    <small>Salu099 &copy; 2018. All rights reserved.</small>	
  </div>
  <div class="small-print">
    
    
	
	<br/><br/>
	
	
	
	<div>
	
	<a href="https://salu099.github.io/blog/" alt="frontpage hit counter" target="_blank" >
	<img  src="//sstatic1.histats.com/0.gif?3898768&101" alt="frontpage hit counter" border="0">
	
	</div>
	
  </div>
</div>

    
</div>


  <div id="main">





  
<div class="header" style="background-image:url('https://lh3.googleusercontent.com/-dK7pYxCnhLA/WbKOyKQHqSI/AAAAAAAAWDM/ZLe7yThctmADiH-qrqGfTJn7US4szsluwCHMYBhgL/s1350/banner.jpg');">
  <h1><a style="text-decoration: none;color: #FFF;" href="https://salu099.github.io/blog/">小卷的胡言亂語</a></h1>
  <h2>隨心。隨興。隨喜。隨緣</h2>
  <br/><br/>
</div>  
  
  
  
    

<div class="content">
  
  <h2>使用c#連接google photos api實作</h2>
  
  
  <div class="post-meta">  

  <div>
    <i class="fa fa-calendar fa-fw"></i>
	
    
	    <time>Jun 15, 2018</time>
				
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    			
      <a class="post-taxonomy-topic" href="https://salu099.github.io/blog/topics/%E7%A8%8B%E5%BC%8F%E7%AD%86%E8%A8%98">程式筆記</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://salu099.github.io/blog/tags/c">c#</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://salu099.github.io/blog/tags/google-photos-api">google photos api</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://salu099.github.io/blog/tags/httpwebrequest">httpwebrequest</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://salu099.github.io/blog/tags/mvc">mvc</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://salu099.github.io/blog/tags/oauth2">oauth2</a>
    
  </div>
  
    
  
  
  
  <div>
	
  </div>
  
</div>
  
  
  
  
  
  <div id="postcontentzone"><p>谷歌在2018年I/O大會宣布開放了photos api給開發者使用，終於!<br />
非常需要這支api的傻露研究了一下~。</p>

<h3 id="1-前言">1、前言</h3>

<hr />

<p>傻露一直是picasa的使用者，<br />
由於google在2016年宣布不再更新picasa，建議使用者使用自家的google photos，<br />
並在2018年3月關閉picasa軟體上傳至google photos的通道後，<br />
使用google提供的picasa api無法取得完整的google photos資料，<br />
這讓傻露一直相當頭痛，終於在今年5月看到google釋出photos api的消息，<br />
就來花點時間嘗試看看如何取得自己帳戶內的照片資料啦。</p>

<h3 id="2-事前準備">2、事前準備</h3>

<hr />

<p>開發者請先至google替你的應用程式申請clientid、clientsecret。<br />
<a href="https://console.developers.google.com/" target="_blank">申請網址</a></p>

<p>傻露使用之開發工具為VS2013、以MVC+C#實作讀取的部分。</p>

<h3 id="3-實作">3、實作</h3>

<hr />

<p>1.新增mvc專案<br />
2.nuget下載JSON.NET套件<br />
3.加入命名空間</p>

<pre><code class="language-c#">using Newtonsoft.Json;  
using System.Net;  
using System.Text;  
using System.IO;  
</code></pre>

<p>4.定義向google申請到的clientid、clientsecret，以及在申請頁面中填入的callback url</p>

<pre><code class="language-c#">public class HomeController : Controller
{
    private string strClientID = &quot;{CLIENT_ID}&quot;;
    private string strClientSecret = &quot;{CLIENT_SECRET}&quot;;    
    private string strRedirectUrl = &quot;{CALLBACK_URL}&quot;;   
}
</code></pre>

<p>5.連結至google OAuth</p>

<pre><code class="language-c#">public ActionResult Index()
{
    string Url = &quot;https://accounts.google.com/o/oauth2/auth?scope={0}&amp;redirect_uri={1}&amp;response_type={2}&amp;client_id={3}&amp;state={4}&quot;;  
    
    //scope：欲存取的scope，這裡只作讀取:所有相簿=分享+未分享
    string scope = &quot;https://www.googleapis.com/auth/photoslibrary.readonly&quot;;  
    string redirect_uri = strRedirectUrl;  
    string response_type = &quot;code&quot;;  
    string state = &quot;&quot;;      
    
    Response.Redirect(string.Format(Url, scope, redirect_uri, response_type, strClientID, state));  
    return null;  
}  
</code></pre>

<p>(2018.8月更新)<br />
若使用refresh token，Url字串須加上access_type的參數，值為變數access_type。
更改以及加入代碼如下：</p>

<pre><code class="language-c#">string Url = &quot;https://accounts.google.com/o/oauth2/auth?scope={0}&amp;redirect_uri={1}&amp;response_type={2}&amp;client_id={3}&amp;state={4}&amp;access_type={5}&quot;;  
string access_type=&quot;offline&quot;;   //default=online，若要在使用者離線時亦能存取，須將此值設定為offline。  
Response.Redirect(string.Format(Url, scope, redirect_uri, response_type, strClientID, state, access_type)); 
</code></pre>

<p>關於refresh token的用途，詳細可參考<a href="https://developers.google.com/identity/protocols/OAuth2WebServer" target="_blank">Google Identity Platform文件</a><br />
文件內表示，發給的access token具有時效性，時效一過，重新向谷歌申請時又會向使用者要求重新作Oauth認證。<br />
因此設計refresh token此一機制，在使用者離線時，使用者不需再作Oauth認證，透過refresh token重新取得access token並重新取得資料。</p>

<p>6.在使用者登入並同意存取相簿內資料後，api會回傳一個token data(json格式)。<br />
因此在這裡先定義一個TokenData物件接取資料。</p>

<pre><code class="language-c#">public class TokenData
{
    /// &lt;summary&gt;
    /// access_token
    /// &lt;/summary&gt;
    public string access_token { get; set; }    

    /// &lt;summary&gt;
    /// refresh_token
    /// &lt;/summary&gt;
    public string refresh_token { get; set; }

    /// &lt;summary&gt;
    /// expires_in
    /// &lt;/summary&gt;
    public string expires_in { get; set; }

    /// &lt;summary&gt;
    /// token_type
    /// &lt;/summary&gt;
    public string token_type { get; set; }
    }
</code></pre>

<p>7.接收token data</p>

<pre><code class="language-c#">public ActionResult Callback(string Code)
{
    // 沒有接收到參數
    if (string.IsNullOrEmpty(Code))
        return Content(&quot;沒有收到 Code&quot;);

    string Url = &quot;https://accounts.google.com/o/oauth2/token&quot;;
    string grant_type = &quot;authorization_code&quot;;    
    string redirect_uri = strRedirectUrl;
    string data = &quot;code={0}&amp;client_id={1}&amp;client_secret={2}&amp;redirect_uri={3}&amp;grant_type={4}&quot;;

    //get token
    HttpWebRequest request = HttpWebRequest.Create(Url) as HttpWebRequest;
    string result = null;
    request.Method = &quot;POST&quot;;    // 方法
    request.KeepAlive = true; // 是否保持連線
    request.ContentType = &quot;application/x-www-form-urlencoded&quot;;

    string param = string.Format(data, Code, strClientID, strClientSecret, redirect_uri, grant_type);
    byte[] bs = Encoding.ASCII.GetBytes(param);

    using (Stream reqStream = request.GetRequestStream())
    {
        reqStream.Write(bs, 0, bs.Length);
    }

    using (WebResponse response = request.GetResponse())
    {
        StreamReader sr = new StreamReader(response.GetResponseStream());
        result = sr.ReadToEnd();
        sr.Close();
    }

    TokenData tokenData = JsonConvert.DeserializeObject&lt;TokenData&gt;(result);
    Session[&quot;token&quot;] = tokenData.access_token;  //只取access_token
    
    return RedirectToAction(&quot;CallAPI&quot;);
}
</code></pre>

<p>(2018.8月更新)<br />
如果在上面第5.步驟中設定access_type=&ldquo;offline&rdquo;，於本步驟程式碼執行後，取得的tokenData內即會給予refresh_token之資料<br />
若使用refresh token，更改及新增代碼如下：</p>

<pre><code class="language-c#">string grant_type = &quot;refresh_token&quot;; 
string strRefreshToken = &quot;{REFRESH_TOKEN}&quot;;  
string data = &quot;client_id={0}&amp;client_secret={1}&amp;refresh_token={2}&amp;grant_type={3}&quot;;  
string param = string.Format(data, strClientID, strClientSecret, strRefreshToken, grant_type);    
</code></pre>

<p>8.call api</p>

<pre><code class="language-c#">public ActionResult CallAPI()
{
    //--------1.取得相簿清單-----------
    if (Session[&quot;token&quot;] == null)
        return Content(&quot;請先取得授權！&quot;);

    string token = Session[&quot;token&quot;] as string;
                          
    // 取得album的 API 網址               
    string Url = &quot;https://photoslibrary.googleapis.com/v1/albums?access_token=&quot; + token + &quot;&amp;pageSize=50&quot;;   //pageSize預設=20，上限=50，不加此參數即會只回傳20筆資料
            
    HttpWebRequest request = HttpWebRequest.Create(Url) as HttpWebRequest;
            
    string result = null;   //api回傳的結果
    request.Method = &quot;GET&quot;;    // 方法
    request.KeepAlive = true; // 是否保持連線                       

    using (WebResponse response = request.GetResponse())
    {
        StreamReader sr = new StreamReader(response.GetResponseStream());
        result = sr.ReadToEnd();        

        sr.Close();
    }   

    Response.Write(result);
}
</code></pre>

<p>執行之result列印出來內容大致如下：</p>

<pre><code>{
    &quot;albums&quot;: [
        {
            &quot;id&quot;: &quot;AGj1epU-......&quot;,
            &quot;title&quot;: &quot;相簿1&quot;,
            &quot;productUrl&quot;: &quot;https://photos.google.com/lr/album/AGj1epU-......&quot;,
            &quot;totalMediaItems&quot;: &quot;96&quot;,
            &quot;coverPhotoBaseUrl&quot;: &quot;https://lh3.googleusercontent.com/photos-library/AJZSZux......&quot;
        },
        {
            &quot;id&quot;: &quot;AGj1epUO......&quot;,
            &quot;title&quot;: &quot;相簿2&quot;,
            &quot;productUrl&quot;: &quot;https://photos.google.com/lr/album/AGj1epUO......&quot;,
            &quot;totalMediaItems&quot;: &quot;54&quot;,
            &quot;coverPhotoBaseUrl&quot;: &quot;https://lh3.googleusercontent.com/photos-library/AJZSZux......&quot;
        },
        ...
        ],
    &quot;nextPageToken&quot;: &quot;AH_uQ438......&quot;
}
</code></pre>

<p>如果有&rdquo;nextPageToken&rdquo;此欄位，就代表後面還有資料，要以此token加在api網址後方繼續查詢，可獲得下一組資料。<br />
即把Url改為：</p>

<pre><code class="language-c#">string nextPageToken = &quot;{nextPageToken}&quot;;   //取自上方api回傳之資料  
Url = &quot;https://photoslibrary.googleapis.com/v1/albums?access_token=&quot; + token + &quot;&amp;pageToken=&quot; + nextPageToken + &quot;&amp;pageSize=50&quot;;  
</code></pre>

<p>欲取得單一相簿內所有照片資料，需使用Post方式連接api：</p>

<pre><code class="language-c#">public ActionResult CallAPI()
{
    //接續上方CallAPI()之內容
    string contentUrl = &quot;https://photoslibrary.googleapis.com/v1/mediaItems:search?access_token=&quot; + token + &quot;&amp;pageSize=100&quot;;    //pageSize:預設50，上限100
    string albumid = &quot;AGj1epV5o......&quot;;     //單一相簿的id，即上方result內&quot;albums&quot;之&quot;id&quot;
    request = HttpWebRequest.Create(contentUrl) as HttpWebRequest;
    
    string resultContent = null;  //api回傳的結果
    request.Method = &quot;POST&quot;;    // 方法
    request.KeepAlive = true; // 是否保持連線
    request.ContentType = &quot;application/json; charset=utf-8&quot;;            
    request.Headers.Add(&quot;Authorization&quot;, &quot;Bearer &quot; + token);
               
    string requestBody = &quot;{\&quot;pageSize\&quot;: \&quot;100\&quot;,\&quot;albumId\&quot;: \&quot;&quot;+albumid+&quot;\&quot;}&quot;;    //google要求的格式為{&quot;pageSize&quot;:&quot;100&quot;,&quot;albumId&quot;: &quot;ALBUM_ID&quot;}
    Stream ws = request.GetRequestStream();
    using (var streamWriter = new StreamWriter(ws, new UTF8Encoding(false)))
    {
        streamWriter.Write(requestBody);
        streamWriter.Flush();
        streamWriter.Close();
    }
    
    using (WebResponse response = request.GetResponse())
    {
        StreamReader sr = new StreamReader(response.GetResponseStream());
        resultContent = sr.ReadToEnd();    

        sr.Close();
    }

    Response.Write(resultContent);
}
</code></pre>

<p>執行之resultContent列印出來內容大致如下：</p>

<pre><code>{
  &quot;mediaItems&quot;: [
    {
      &quot;id&quot;: &quot;AGj1epUz......&quot;,
      &quot;description&quot;: &quot;description&quot;,
      &quot;productUrl&quot;: &quot;https://photos.google.com/lr/album/AGj1epUu......&quot;,
      &quot;baseUrl&quot;: &quot;https://lh3.googleusercontent.com/photos-library/AJZSZuyU......&quot;,
      &quot;mimeType&quot;: &quot;image/jpeg&quot;,
      &quot;mediaMetadata&quot;: {
        &quot;creationTime&quot;: &quot;2014-09-06T13:53:36Z&quot;,
        &quot;width&quot;: &quot;800&quot;,
        &quot;height&quot;: &quot;450&quot;,
        &quot;photo&quot;: {}
      }
    },
    ]
}  
</code></pre>

<p>與上面抓取所有相簿資料相同的，如果有&rdquo;nextPageToken&rdquo;此欄位，就代表後面還有資料，要獲得下一組資料就必須以此token加在api網址後方繼續查詢。</p>

<h2 id="總結">總結</h2>

<p>以上程式碼示範了讀取相簿資料，其他還有新增、更新等等的部分，原則是差不多的，參考文件實作應該不會太難。</p>

<p>原先傻露是為了要以api取得google相簿資料以製作自己的相簿藝廊(photo album / gallery)，<br />
畢竟目前google相簿<br />
1.相簿排序無法變更為自己喜愛的方式(按照相簿名稱排序)<br />
2.只有單一相簿連結分享，無UI可看到所有公開的相簿</p>

<p>而在傻露實際try過google photos api後發現：<br />
1.<del>以token取得的相簿、照片資訊，包含id、baseurl(圖床)，依不同token均不同</del><br />
每次以不同access token取得的相簿、照片資訊，包含id、baseurl(圖床)均不同(2018.8月更新)<br />
2.若是透由【google相簿】上傳的資料，上述1.取得的資料具有時效性，時效一過，沒有登入google帳戶該張圖片是會產生破圖，無法讀取的(時效大約1日內吧)</p>

<p>雖然不清楚google這樣做的目的是甚麼，不過傻露大概猜測了一下，<br />
除了不鼓勵使用者把google的相簿當作圖床來使用、不希望使用者可以像picasa那樣容易取得相簿的json資料、也不希望開發者儲存使用者的資料吧，<br />
所以雖然乍看之下可以透過google photos api取得自己的所有相簿資料，但就製作公開的gallery而言有困難，<br />
所以也只好放棄google photos api這條管道了，<br />
只好安慰自己，當作一個程式練習，也多了解google api如何運作囉。</p>

<p>另外感謝網友Allen提醒access token與refresh token之不同，傻露也據此調整了內文。<br />
若有未盡詳細或錯誤之處，也歡迎各位指正，謝謝。^_^&rdquo;</p>

<h2 id="參考資料">參考資料</h2>

<p><a href="https://developers.google.com/photos/library/guides/get-started" target="_blank">Google Photos API</a><br />
<a href="https://developers.google.com/identity/protocols/OAuth2WebServer" target="_blank">Google Identity Platform</a><br />
<a href="http://coding.anyun.tw/2012/03/14/asp-net-mvc-using-oauth-2-0-connect-google-api/" target="_blank">【oAuth 2.0 實作系列】ASP.Net MVC 實作使用 oAuth 2.0 連接 Google API</a><br />
<a href="http://challenge.no1s.biz/programming/459" target="_blank">Android アプリで Google Photos APIs を使ってみた！！</a></p></div>
  
  
  <br/>
  <div>
	<iframe src='' scrolling='no' frameborder='0' style='width:150px; height:20px;' allowTransparency='true' onload='this.src="https://www.facebook.com/plugins/like.php?locale=zh_TW&amp;href=https://" + location.hostname + location.pathname + "&amp;layout=button_count&amp;action=like&amp;colorscheme=light&amp;share=true"; this.onload="";'></iframe>		
	<div class='g-plusone' data-size='medium'></div>
	
  </div>
  <br/>
  
  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://salu099.github.io/blog/2018/05/2016-japan-kyoto-maple-komyoin/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://salu099.github.io/blog/2018/05/2016-japan-kyoto-maple-komyoin/">2016/12 日本京都小旅行 - 光明院 迷你寺院賞楓趣</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://salu099.github.io/blog/2018/08/2016-japan-kyoto-maple-kamomioyajinjia/">2016/12 日本京都小旅行 - 世界文化遺產下鴨神社</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://salu099.github.io/blog/2018/08/2016-japan-kyoto-maple-kamomioyajinjia/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

<br/>
<div id="disqusbtn"><button class="show-comments" >留言</button></div>
<br/>

<div id="disqus_thread"></div>





    
    
    
        

    
    
    
    







</div>

</div>
</div>
<script src="https://salu099.github.io/blog/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106389797-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>

